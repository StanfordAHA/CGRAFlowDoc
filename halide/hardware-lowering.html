
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>Hardware Lowering Â· The Ultimate Documentation for CGRAFlow</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 3.6.20">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="codegen.html" />
    
    
    <link rel="prev" href="compilation.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../overview/toolchain.html">
            
                <a href="../overview/toolchain.html">
            
                    
                    Tool Chain Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../cgra/cgra-generator.html">
            
                <a href="../cgra/cgra-generator.html">
            
                    
                    CGRA Generator
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../cgra/pe-spec.html">
            
                <a href="../cgra/pe-spec.html">
            
                    
                    PE Spec
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="intro.html">
            
                <a href="intro.html">
            
                    
                    Halide
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="installation.html">
            
                <a href="installation.html">
            
                    
                    Installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="usage.html">
            
                <a href="usage.html">
            
                    
                    Usage Instructions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="halide-basics.html">
            
                <a href="halide-basics.html">
            
                    
                    Halide Basics
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.3.1" data-path="writing-apps.html">
            
                <a href="writing-apps.html">
            
                    
                    Writing Applications
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3.2" data-path="operations.html">
            
                <a href="operations.html">
            
                    
                    Supported Operations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3.3" data-path="application-list.html">
            
                <a href="application-list.html">
            
                    
                    Application List
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="compilation.html">
            
                <a href="compilation.html">
            
                    
                    Compilation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.4.4.1" data-path="hardware-lowering.html">
            
                <a href="hardware-lowering.html">
            
                    
                    Hardware Lowering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4.2" data-path="codegen.html">
            
                <a href="codegen.html">
            
                    
                    Code Generation
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="testing.html">
            
                <a href="testing.html">
            
                    
                    Testing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../coreir/intro.html">
            
                <a href="../coreir/intro.html">
            
                    
                    CoreIR
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../pnr/intro.html">
            
                <a href="../pnr/intro.html">
            
                    
                    Place and Route
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../pnr/packing.html">
            
                <a href="../pnr/packing.html">
            
                    
                    Packing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../pnr/placement.html">
            
                <a href="../pnr/placement.html">
            
                    
                    Placement
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.2.1" data-path="../pnr/global-placement.html">
            
                <a href="../pnr/global-placement.html">
            
                    
                    Global Placement
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.2" data-path="../pnr/detailed-placement.html">
            
                <a href="../pnr/detailed-placement.html">
            
                    
                    Detailed Placement
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../pnr/routing.html">
            
                <a href="../pnr/routing.html">
            
                    
                    Routing
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.3.1" data-path="../pnr/global-routing.html">
            
                <a href="../pnr/global-routing.html">
            
                    
                    Global Routing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.2" data-path="../pnr/detailed-routing.html">
            
                <a href="../pnr/detailed-routing.html">
            
                    
                    Detailed Routing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../pnr/bitstream-gen.html">
            
                <a href="../pnr/bitstream-gen.html">
            
                    
                    Bitstream Generation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../pnr/testing.html">
            
                <a href="../pnr/testing.html">
            
                    
                    Testing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="../pnr/analysis.html">
            
                <a href="../pnr/analysis.html">
            
                    
                    Analysis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="../pnr/retiming.html">
            
                <a href="../pnr/retiming.html">
            
                    
                    Retiming
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../bsbuilder/bsbuilder.html">
            
                <a href="../bsbuilder/bsbuilder.html">
            
                    
                    Assembler (BSBuilder)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../bsbuilder/bitstream-spec.html">
            
                <a href="../bsbuilder/bitstream-spec.html">
            
                    
                    Bitstream Specification
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../simulator/simulator.html">
            
                <a href="../simulator/simulator.html">
            
                    
                    Simulator (run_tbg)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../tbg/intro.html">
            
                <a href="../tbg/intro.html">
            
                    
                    Test Bench Generator
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../tbg/harness_generation.html">
            
                <a href="../tbg/harness_generation.html">
            
                    
                    Harness Generation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="../tbg/io-json.html">
            
                <a href="../tbg/io-json.html">
            
                    
                    .io.json format
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="../tbg/pre_post_processing.html">
            
                <a href="../tbg/pre_post_processing.html">
            
                    
                    Pre/Post Processing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="../tbg/roadmap.html">
            
                <a href="../tbg/roadmap.html">
            
                    
                    Roadmap
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Hardware Lowering</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="hardware-lowering">Hardware Lowering</h1>
<p>There are several small lowering passes that are unique to hardware for generating
Clockwork. These passes extract the hardware accelerators, retain n-d memory indexing,
merge unrolled memories, inline memory constants, and retain BFloat math.</p>
<h2 id="hardware-accelerator-extraction">Hardware Accelerator Extraction</h2>
<p>This pass identifies which functions have been accelerated with the <code>hw_accelerate()</code> scheduling
call. The store loop is saved, and then the HalideIR is modified to denote where the accelerator
should be produced. A produce node creating <code>_hls_target.</code> is created inside the store loop.
Later, the codegen uses this node to know when to start generating Clockwork code.</p>
<h2 id="multi-dimensional-memory-indexing">Multi-dimensional Memory Indexing</h2>
<p>Multi-dimensional loads (calls) and stores (provides) are typically flattened to one-dimensional
memories. However, the multi-dimensional indexing can be helpful for Clockwork. Therefore,
the convention we use is that by appending <code>.stencil</code> to a function, the memory is not flattened,
and is recognized as function used in a hardware accelerator.</p>
<h2 id="unrolled-memory-update-merging">Unrolled Memory Update Merging</h2>
<p>When a reduction loop is unrolled, typically the updates all occur as different memory
operations. However, this would produce many updates and small computation kernels for
Clockwork. Instead, we combine iterative updates from unrolled reduction loops into a single
computation.</p>
<h2 id="memory-constant-inlining">Memory Constant Inlining</h2>
<p>Some functions in Halide are created that look like memories, but in Clockwork are easier to
treat as computation blocks. This is when they are preloaded with values and then only stores
are performed. They can either be <code>ROM</code>s or <code>CONSTS</code> based on the nature of the loads and stores.
When this occurs, they are transformed into computation by removing the <code>realization</code> node.</p>
<h2 id="bfloat-math">BFloat Math</h2>
<p>The CGRA has BFloat operators, so those are native operations. However, a CPU natively can only
perform 32 bit floating point operations, so emulation must be done to get bit-exact comparisons
on the CPU and CGRA outputs. <code>EmulateFloat16Math.cpp</code> performs these math conversions to
ensure the output of each hardware target is consistent. Note that during emulation, each CPU
BFloat operation instead takes many operations to execute (including casts and shifts).</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="compilation.html" class="navigation navigation-prev " aria-label="Previous page: Compilation">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="codegen.html" class="navigation navigation-next " aria-label="Next page: Code Generation">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Hardware Lowering","level":"1.4.4.1","depth":3,"next":{"title":"Code Generation","level":"1.4.4.2","depth":3,"path":"halide/codegen.md","ref":"halide/codegen.md","articles":[]},"previous":{"title":"Compilation","level":"1.4.4","depth":2,"path":"halide/compilation.md","ref":"halide/compilation.md","articles":[{"title":"Hardware Lowering","level":"1.4.4.1","depth":3,"path":"halide/hardware-lowering.md","ref":"halide/hardware-lowering.md","articles":[]},{"title":"Code Generation","level":"1.4.4.2","depth":3,"path":"halide/codegen.md","ref":"halide/codegen.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["mathjax","expandable-chapters"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"mathjax":{"forceSVG":false,"version":"2.6.1"},"expandable-chapters":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"The Ultimate Documentation for CGRAFlow","gitbook":"*"},"file":{"path":"halide/hardware-lowering.md","mtime":"2021-05-20T04:04:15.521Z","type":"markdown"},"gitbook":{"version":"3.6.20","time":"2021-05-20T04:04:32.077Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-mathjax/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

