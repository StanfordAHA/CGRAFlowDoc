
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>Writing Schedules Â· The Ultimate Documentation for CGRAFlow</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 3.6.20">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="operations.html" />
    
    
    <link rel="prev" href="writing-apps.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../overview/toolchain.html">
            
                <a href="../overview/toolchain.html">
            
                    
                    Tool Chain Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../cgra/cgra-generator.html">
            
                <a href="../cgra/cgra-generator.html">
            
                    
                    CGRA Generator
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../cgra/pe-spec.html">
            
                <a href="../cgra/pe-spec.html">
            
                    
                    PE Spec
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="intro.html">
            
                <a href="intro.html">
            
                    
                    Halide
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="installation.html">
            
                <a href="installation.html">
            
                    
                    Installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="usage.html">
            
                <a href="usage.html">
            
                    
                    Usage Instructions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="halide-basics.html">
            
                <a href="halide-basics.html">
            
                    
                    Halide Basics
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.3.1" data-path="writing-apps.html">
            
                <a href="writing-apps.html">
            
                    
                    Writing Applications
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4.3.2" data-path="writing-schedules.html">
            
                <a href="writing-schedules.html">
            
                    
                    Writing Schedules
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3.3" data-path="operations.html">
            
                <a href="operations.html">
            
                    
                    Supported Operations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3.4" data-path="application-list.html">
            
                <a href="application-list.html">
            
                    
                    Application List
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="compilation.html">
            
                <a href="compilation.html">
            
                    
                    Compilation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.4.1" data-path="hardware-lowering.html">
            
                <a href="hardware-lowering.html">
            
                    
                    Hardware Lowering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4.2" data-path="codegen.html">
            
                <a href="codegen.html">
            
                    
                    Code Generation
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="testing.html">
            
                <a href="testing.html">
            
                    
                    Testing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../coreir/intro.html">
            
                <a href="../coreir/intro.html">
            
                    
                    CoreIR
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../pnr/intro.html">
            
                <a href="../pnr/intro.html">
            
                    
                    Place and Route
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../pnr/packing.html">
            
                <a href="../pnr/packing.html">
            
                    
                    Packing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../pnr/placement.html">
            
                <a href="../pnr/placement.html">
            
                    
                    Placement
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.2.1" data-path="../pnr/global-placement.html">
            
                <a href="../pnr/global-placement.html">
            
                    
                    Global Placement
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.2" data-path="../pnr/detailed-placement.html">
            
                <a href="../pnr/detailed-placement.html">
            
                    
                    Detailed Placement
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../pnr/routing.html">
            
                <a href="../pnr/routing.html">
            
                    
                    Routing
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.3.1" data-path="../pnr/global-routing.html">
            
                <a href="../pnr/global-routing.html">
            
                    
                    Global Routing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.2" data-path="../pnr/detailed-routing.html">
            
                <a href="../pnr/detailed-routing.html">
            
                    
                    Detailed Routing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../pnr/bitstream-gen.html">
            
                <a href="../pnr/bitstream-gen.html">
            
                    
                    Bitstream Generation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../pnr/testing.html">
            
                <a href="../pnr/testing.html">
            
                    
                    Testing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="../pnr/analysis.html">
            
                <a href="../pnr/analysis.html">
            
                    
                    Analysis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="../pnr/retiming.html">
            
                <a href="../pnr/retiming.html">
            
                    
                    Retiming
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../bsbuilder/bsbuilder.html">
            
                <a href="../bsbuilder/bsbuilder.html">
            
                    
                    Assembler (BSBuilder)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../bsbuilder/bitstream-spec.html">
            
                <a href="../bsbuilder/bitstream-spec.html">
            
                    
                    Bitstream Specification
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../simulator/simulator.html">
            
                <a href="../simulator/simulator.html">
            
                    
                    Simulator (run_tbg)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../tbg/intro.html">
            
                <a href="../tbg/intro.html">
            
                    
                    Test Bench Generator
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../tbg/harness_generation.html">
            
                <a href="../tbg/harness_generation.html">
            
                    
                    Harness Generation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="../tbg/io-json.html">
            
                <a href="../tbg/io-json.html">
            
                    
                    .io.json format
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="../tbg/pre_post_processing.html">
            
                <a href="../tbg/pre_post_processing.html">
            
                    
                    Pre/Post Processing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="../tbg/roadmap.html">
            
                <a href="../tbg/roadmap.html">
            
                    
                    Roadmap
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Writing Schedules</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="writing-schedules">Writing Schedules</h1>
<p>Below are some tips for writing Halide schedules.</p>
<h2 id="schedule">Schedule</h2>
<p>While the algorithm defines the output pixels, the schedule determines how
to run on the specified hardware. These decisions can be used to improve the
runtime, code size, or utilization of the end application.</p>
<h2 id="schedule-structure">Schedule Structure</h2>
<p>The schedule typically follows a certain unique structure where the output is
scheduled first, and then it proceeds &quot;backwards&quot; toward the input. This is done
because some of the scheduling primitives refer to their output, such as <code>compute_at</code>.</p>
<p>Another quality to note is that the Halide scheduling language is not performed
sequentially, meaning that all of the scheduling calls will all occur for the program,
and the order of the calls does not matter too much.</p>
<p>Furthermore, while the Halide scheduling language is itself following syntax unique to
its own language, it is still embedded in C++. This means that you can still use printf
and <code>if</code> statements to control how the schedule is performed.</p>
<h2 id="targets">Targets</h2>
<p>After the application algorithm, one should specify the schedule for different
hardware targets. Typically, hardware targets require their own unique schedules
due to the different metrics and contraints on the hardware. For example, a CPU
and a custom CGRA accelerator have much different memory hierarchy and size, so the
corresponding tiling will have different sizes.</p>
<p>Each of these schedules usually exist in a if/else if/else block:</p>
<pre><code class="lang-C++">  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">get_target</span>().<span class="hljs-built_in">has_feature</span>(Target::Clockwork)) {  ...
</code></pre>
<h2 id="clockwork-target-schedules">Clockwork Target Schedules</h2>
<p>The Clockwork target schedule is the one used to target the CGRA. The memory file is
sent to Clockwork, while the compute is codegen&apos;ed into a json file. Some of the
scheduling primitives are new for hardware, as well as some primitives (such as unroll)
have a different meaning for hardware targets.</p>
<h3 id="bounding-image-sizes">Bounding Image Sizes</h3>
<p>The image sizes should be bounded since the hardware needs to have a size at compile-time.
This allows the memories to have a determined size. To bound the output width and height, use
<code>bound</code> like:</p>
<pre><code class="lang-C++">      <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> outputWidth  = <span class="hljs-number">64</span>;
      <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> outputHeight = <span class="hljs-number">128</span>;
      output.<span class="hljs-built_in">bound</span>(x, <span class="hljs-number">0</span>, outputWidth);
      output.<span class="hljs-built_in">bound</span>(y, <span class="hljs-number">0</span>, outputHeight);
</code></pre>
<p>Sometimes, input sizes also must be bound if they cannot be determined from the output size.
For example, the number of input channels for a DNN layer does not depend on the output. In
this case, an input bound is needed.</p>
<h3 id="defining-hardware-boundaries">Defining Hardware Boundaries</h3>
<p>The hardware accelerator is part of an application that runs on the host processor. Scheduling
primitives are used to define the transfer to the accelerator and from the accelerator. These
primitives are <code>stream_to_accelerator</code> and <code>hw_accelerate</code>. <code>stream_to_accelerator</code> is used
on each input. It takes no arguments, and it is simply checked in the compiler to ensure that
the correct accelerator input is defined when creating the accelerator.</p>
<p>The output is defined by <code>hw_accelerate(compute_var, store_var)</code>. The function that has this
scheduling function is the output from the accelerator. The first argument is unused, but
defines what variable is a single cycle on the hardware. The second variable, <code>store_var</code> is
the first loop that is performed outside the accelerator. For example:</p>
<pre><code class="lang-C++">       hw_output
         .<span class="hljs-built_in">tile</span>(x, y, xo, yo, xi, yi, <span class="hljs-number">64</span>, <span class="hljs-number">128</span>)
         .<span class="hljs-built_in">hw_accelerate</span>(xi, xo);
       hw_input.
         .<span class="hljs-built_in">accelerator_input</span>();
</code></pre>
<p>In this example, the loops <code>xi</code> and <code>yi</code> are size 64 and 128 respectively, and are executed
on the CGRA. The outer loops, <code>xo</code> and <code>yo</code> are performed outside the accelerator. This
effectively means that the accelerator is called <code>xo * yo</code> times to calculate the full output.</p>
<h3 id="splitting-reordering-and-tiling">Splitting, Reordering, and Tiling</h3>
<p>There are scheduling primitives to separate loops and determine the loop order. <code>split</code> is used
to take a single loop variable and construct two nested loops from it. For example:</p>
<pre><code class="lang-C++">      output_glb
         .<span class="hljs-built_in">split</span>(w, w_glb, w_cgra, <span class="hljs-number">8</span>)
</code></pre>
<p>In this example, the <code>w</code> loop is decomposed into a <code>w_cgra</code> loop of size 8 and a <code>w_glb</code> loop
that covers the rest of the loop iteration. Every 8 iterations of <code>w_cgra</code> increments <code>w_glb</code>
once.</p>
<p>To determine the order of your loop variables (including split variables), we can use <code>reorder</code>.
This lists the loops from inner-loop-variable to outermost-loop-variable. For example:</p>
<pre><code class="lang-C++">       output_glb
         .<span class="hljs-built_in">tile</span>(x, y, x_glb,y_glb, x_cgra,y_cgra, tilesize_x,tilesize_y)
         .<span class="hljs-built_in">split</span>(w, w_glb, w_cgra, k_oc)
         <span class="hljs-comment">// reorder from inner to outermost</span>
         .<span class="hljs-built_in">reorder</span>(w_cgra, x_cgra, y_cgra,
                  w_glb, x_glb, y_glb);
</code></pre>
<p>We first split loops using <code>tile</code> and <code>split</code>. Afterwards, we have 6 separate loop variables
for the function <code>output_glb</code>. The <code>reorder</code> determines the loop ordering of these 6 variables.</p>
<p>Finally, there is <code>tile</code>, which is just syntatic sugar for <code>split</code> and <code>reorder</code>. This scheduling
primitive was created since splitting and reordering images into tiles usually is a common process.
Two equivalent schedules would thus be:</p>
<pre><code class="lang-C++">       output_glb
         .<span class="hljs-built_in">tile</span>(x, y, x_glb,y_glb, x_cgra,y_cgra, tilesize_x,tilesize_y);
</code></pre>
<p>and:</p>
<pre><code class="lang-C++">       output_glb
         .<span class="hljs-built_in">split</span>(x, x_glb, x_cgra, tilesize_x)
         .<span class="hljs-built_in">split</span>(y, y_glb, y_cgra, tilesize_y)
         .<span class="hljs-built_in">reorder</span>(x_cgra, y_cgra, x_glb, y_glb);
</code></pre>
<h3 id="duplicating-compute">Duplicating Compute</h3>
<p>Duplicating compute is useful to perform a computation in fewer cycles. This is done by performing
multiple iterations of a loop in a single cycle. In hardware, this is done by duplicating compute
resources. Similar to HLS semanatics, we use <code>unroll</code> to express this hardware duplication.</p>
<p>One of the common uses of hardware duplication is for unrolling a reduction domain to perform in
a single cycle.</p>
<pre><code class="lang-C++">  <span class="hljs-function">RDom <span class="hljs-title">win</span><span class="hljs-params">(<span class="hljs-number">0</span>, blockSize, <span class="hljs-number">0</span>, blockSize)</span></span>;
  <span class="hljs-built_in">blur</span>(x, y) += <span class="hljs-built_in">kernel</span>(win.x, win.y) * <span class="hljs-built_in">hw_input</span>(x+win.x, y+win.y);

   blur.<span class="hljs-built_in">update</span>()
      .<span class="hljs-built_in">unroll</span>(win.x)
      .<span class="hljs-built_in">unroll</span>(win.y);
</code></pre>
<p>This example shows that a reduction domain <code>win</code> is used to perform a convolution. This computation
would normally be performed in <code>blockSize * blockSize</code> iterations. We can get a handle on the
adder chain by using <code>blur.update()</code>, and then unroll this computation using <code>unroll</code> to duplicate
the compute completely to perform it in a single cycle.</p>
<p>We can further unroll computation to perform multiple pixels per cycle. We typically want to unroll
the innermost dimension to allow for the memories to input the subsequent values more easily.
For example:</p>
<pre><code class="lang-C++">   blur.<span class="hljs-built_in">update</span>()
      .<span class="hljs-built_in">unroll</span>(win.x)
      .<span class="hljs-built_in">unroll</span>(win.y);
      .<span class="hljs-built_in">unroll</span>(x, <span class="hljs-number">3</span>, TailStrategy::RoundUp);
</code></pre>
<p>This schedule has unrolled the reduction domain to perform in a single cycle, and thens the
innermost loop, <code>x</code>, is unrolled by 3 to make it 3 pixels/cycle. The <code>TailStrategy::RoundUp</code> is
used to increase the loop size in case the image width (the extent of <code>x</code>)  is not divisible by 3.</p>
<p>Note that even after unrolling the compute, the rest of the application should be equally unrolled.
Duplicating hardware at one compute kernel is usually not helpful if the rate of the other kernels
are not similarly duplicated. Furthermore, even if all of the compute kernels are unrolled, the
initializations and memory transfers also need to also support the same rate. These schedules will
thus commonly also include lines like below:</p>
<pre><code class="lang-C++">   <span class="hljs-comment">// unroll the initialization</span>
   blur.<span class="hljs-built_in">unroll</span>(x, <span class="hljs-number">3</span>, TailStrategy::RoundUp);

   <span class="hljs-comment">// unroll the output and input memories</span>
   hw_output.<span class="hljs-built_in">unroll</span>(xi, <span class="hljs-number">3</span>, TailStrategy::RoundUp);
   hw_input.<span class="hljs-built_in">unroll</span>(x, <span class="hljs-number">3</span>, TailStrategy::RoundUp);
</code></pre>
<h3 id="creating-memories">Creating Memories</h3>
<p>In addition to compute, it is important to schedule the memories properly. Without any scheduling
all compute is by default computed in-line. This means that no reuse is used and lots of compute
resources are created. For most applications, it is worth to create memories anywhere you can,
because the memory resources are usually abundant and the reduction in compute resources is
significant.</p>
<p>A memory can be created for any Func, but it is only useful (and becomes a memory) when there
is some sort of reuse. This can be seen in the Halide algorithm when there is an offset in
the index, or a reduction domain is used. For example:</p>
<pre><code class="lang-C++">   <span class="hljs-built_in">blur_y</span>(x, y) = (<span class="hljs-built_in">blur_x</span>(x, y) + <span class="hljs-built_in">blur_x</span>(x, y+<span class="hljs-number">1</span>) + <span class="hljs-built_in">blur_x</span>(x, y+<span class="hljs-number">2</span>))/<span class="hljs-number">3</span>;

   <span class="hljs-built_in">blur</span>(x, y) += <span class="hljs-built_in">kernel</span>(win.x, win.y) * <span class="hljs-built_in">hw_input</span>(x+win.x, y+win.y);
</code></pre>
<p>For these two, <code>blur_x</code>, <code>kernel</code>, and <code>hw_input</code> should be stored in a memory. To schedule these
Funcs in memory tiles, use <code>compute_at</code> and <code>store_at</code>:</p>
<pre><code class="lang-C++">   blur_x.<span class="hljs-built_in">compute_at</span>(hw_output, xo).<span class="hljs-built_in">store_at</span>(hw_output, xo);

   hw_input.<span class="hljs-built_in">compute_at</span>(hw_output, xo).<span class="hljs-built_in">store_at</span>(hw_output, xo);
</code></pre>
<p>The arguments are used to specify which Func and loop variable where this memory should be created.
Effectively, a memory is created at the specified loop level, and any reuse within that will be
captured. For a hardware accelerator without hierarchy, this is commonly the output Func (that is
accelerated) and the store (second) variable. Note that due to the requirements of a <code>store_at</code> and
<code>compute_at</code>, usually only <code>compute_at</code> is necessary to specify, since it will automatically store
at the same level.</p>
<p>As a further clarification of this process, it may seem odd that the compute level is the same as
the store level. Usually in Halide this means that the computation would be computed first at the
specified level, and only afterwards continue the computation. This would typically lead to a much
larger memory storage at each level than necessary, as well as create serial code. Instead, Clockwork
prefers this specification, but will instead create the line buffers that are expected. In effect,
all memories therefore are scheduled this way, and Clockwork fixes the compute level based on its
own analysis.</p>
<h3 id="more-hardware-boundaries">More Hardware Boundaries</h3>
<p>Although <code>hw_accelerate</code> and <code>stream_to_accelerator</code> are the basic ways of specifying the boundary,
there are more complications internally. In <code>src/Func.cpp</code>, one will find that <code>stream_to_accelerator()</code>
is simply syntatic sugar for <code>.in()</code> as well as <code>is_accelerator_input</code>. In effect, this call is
creating the necessary memory hierarchy needed for Clockwork. To have more control of these input and
output labels, one can find <code>accelerator_input()</code>, <code>accelerator_output()</code>, and <code>accelerate_call_output()</code>.
Not all of these scheduling primitives are fully fleshed out, but they can be used to specify more
advanced application structures such as create memory hierarchies and use multiple <code>hw_accelerate</code>
calls in a single application.</p>
<h3 id="creating-memory-hierarchy">Creating Memory Hierarchy</h3>
<p>Creating a memory hierarchy is a matter of specifying a series of copies from larger memories
to smaller memories. In effect, the computation between them are NOPs, and then tiling should
occur to specify the differing sizes.</p>
<p>Halide provides the means of performing these copies using <code>.in()</code>. The generated Func will end with
<code>global_wrapper</code>, but no computation will occur between them. When creating the memory hierarchy,
one should create a hierarchy at both the input and output, and align the copies using <code>compute_at</code>.</p>
<p>An example of a memory hierarchy using three levels:</p>
<pre><code class="lang-C++">      hw_output.<span class="hljs-built_in">in</span>().<span class="hljs-built_in">compute_root</span>();

      hw_output.<span class="hljs-built_in">in</span>()
        .<span class="hljs-built_in">tile</span>(x, y, xo, yo, xi, yi, glbWidth, glbHeight)
        .<span class="hljs-built_in">hw_accelerate</span>(xi, xo);
      hw_output.<span class="hljs-built_in">in</span>().<span class="hljs-built_in">store_in</span>(MemoryType::GLB);

      Var xii, yii, xio, yio;
      hw_output
        .<span class="hljs-built_in">tile</span>(x, y, xo, yo, xi, yi, tileWidth, tileHeight);
      hw_output.<span class="hljs-built_in">compute_at</span>(hw_output.<span class="hljs-built_in">in</span>(), xo);

      blur_unnormalized.<span class="hljs-built_in">update</span>()
        .<span class="hljs-built_in">unroll</span>(win.x, blockSize)
        .<span class="hljs-built_in">unroll</span>(win.y, blockSize);
      blur_unnormalized.<span class="hljs-built_in">compute_at</span>(hw_output, xo);

      blur.<span class="hljs-built_in">compute_at</span>(hw_output, xo);

      hw_input.<span class="hljs-built_in">in</span>().<span class="hljs-built_in">in</span>().<span class="hljs-built_in">compute_at</span>(hw_output, xo); <span class="hljs-comment">// represents the mem tile</span>

      hw_input.<span class="hljs-built_in">in</span>().<span class="hljs-built_in">compute_at</span>(hw_output.<span class="hljs-built_in">in</span>(), xo);
      hw_input.<span class="hljs-built_in">in</span>().<span class="hljs-built_in">store_in</span>(MemoryType::GLB);

      hw_input.<span class="hljs-built_in">compute_root</span>()
        .<span class="hljs-built_in">accelerator_input</span>();
</code></pre>
<p>Here you&apos;ll notice that the global buffer level at the input and output are labelled using
<code>store_in(MemoryType::GLB)</code>. The accelerator output is the GLB <code>hw_output.in()</code> meaning that the
input GLB, <code>hw_input.in()</code> is computed at this same level: <code>hw_input.in().compute_at(hw_output.in(), xo)</code>.
The inner compute on the CGRA has its own tiling (<code>hw_output.tile()</code>) as well as its own input
memory tile that is computed at the CGRA output (<code>hw_input.in().in().compute_at(hw_output, xo)</code>).
This effectively creates a three level memory hierarchy with the levels: host, GLB, and memory tile.</p>
<h2 id="cpu-target-schedules">CPU Target Schedules</h2>
<p>CPU schedules are different from Clockwork and hardware targets. The memory sizes are different,
and scheduling primitives such as <code>parallel</code> and <code>vectorize</code> play a key role in improving runtimes.
Furthermore, <code>compute_at</code> and <code>store_at</code> play a far more complex and important role to ensure that
values fit in different cache sizes. There are many tradeoffs to consider when trying to achieve
the fastest CPU implementation for any given machine.</p>
<h2 id="debugging-schedules">Debugging Schedules</h2>
<p>There are several places to look to identify whether the schedule is performing how you expect. By
modifying <code>src/Lower.cpp</code>, one can output the HalideIR at any stage (I recommend especially the final
stage before codegen). In addition, the generated code (<code>bin/&lt;app&gt;_memory.cpp</code> and <code>bin/&lt;app&gt;_compute.h</code>)
can help identify what calls are being created in the hardware.</p>
<h2 id="extending-the-scheduling-language">Extending the Scheduling Language</h2>
<p>While most of the functionality for the scheduling language exists in Halide, one might find that
extending the scheduling to be needed. This might be for additional functionality or additional
syntatic sugar. These modifications will start in <code>src/Func.cpp</code>.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="writing-apps.html" class="navigation navigation-prev " aria-label="Previous page: Writing Applications">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="operations.html" class="navigation navigation-next " aria-label="Next page: Supported Operations">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Writing Schedules","level":"1.4.3.2","depth":3,"next":{"title":"Supported Operations","level":"1.4.3.3","depth":3,"path":"halide/operations.md","ref":"halide/operations.md","articles":[]},"previous":{"title":"Writing Applications","level":"1.4.3.1","depth":3,"path":"halide/writing-apps.md","ref":"halide/writing-apps.md","articles":[]},"dir":"ltr"},"config":{"plugins":["mathjax","expandable-chapters"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"mathjax":{"forceSVG":false,"version":"2.6.1"},"expandable-chapters":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"The Ultimate Documentation for CGRAFlow","gitbook":"*"},"file":{"path":"halide/writing-schedules.md","mtime":"2021-09-15T21:43:16.156Z","type":"markdown"},"gitbook":{"version":"3.6.20","time":"2021-09-15T21:43:34.796Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-mathjax/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

