
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>Harness Generation Â· The Ultimate Documentation for CGRAFlow</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 3.6.20">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="io-json.html" />
    
    
    <link rel="prev" href="intro.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../overview/toolchain.html">
            
                <a href="../overview/toolchain.html">
            
                    
                    Tool Chain Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../cgra/cgra-generator.html">
            
                <a href="../cgra/cgra-generator.html">
            
                    
                    CGRA Generator
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../cgra/pe-spec.html">
            
                <a href="../cgra/pe-spec.html">
            
                    
                    PE Spec
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../halide/intro.html">
            
                <a href="../halide/intro.html">
            
                    
                    Halide
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../halide/installation.html">
            
                <a href="../halide/installation.html">
            
                    
                    Installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../halide/usage.html">
            
                <a href="../halide/usage.html">
            
                    
                    Usage Instructions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../halide/halide-basics.html">
            
                <a href="../halide/halide-basics.html">
            
                    
                    Halide Basics
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.3.1" data-path="../halide/writing-apps.html">
            
                <a href="../halide/writing-apps.html">
            
                    
                    Writing Applications
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3.2" data-path="../halide/writing-schedules.html">
            
                <a href="../halide/writing-schedules.html">
            
                    
                    Writing Schedules
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3.3" data-path="../halide/operations.html">
            
                <a href="../halide/operations.html">
            
                    
                    Supported Operations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3.4" data-path="../halide/application-list.html">
            
                <a href="../halide/application-list.html">
            
                    
                    Application List
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../halide/compilation.html">
            
                <a href="../halide/compilation.html">
            
                    
                    Compilation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.4.1" data-path="../halide/hardware-lowering.html">
            
                <a href="../halide/hardware-lowering.html">
            
                    
                    Hardware Lowering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4.2" data-path="../halide/codegen.html">
            
                <a href="../halide/codegen.html">
            
                    
                    Code Generation
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../halide/testing.html">
            
                <a href="../halide/testing.html">
            
                    
                    Testing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../coreir/intro.html">
            
                <a href="../coreir/intro.html">
            
                    
                    CoreIR
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../pnr/intro.html">
            
                <a href="../pnr/intro.html">
            
                    
                    Place and Route
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../pnr/packing.html">
            
                <a href="../pnr/packing.html">
            
                    
                    Packing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../pnr/placement.html">
            
                <a href="../pnr/placement.html">
            
                    
                    Placement
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.2.1" data-path="../pnr/global-placement.html">
            
                <a href="../pnr/global-placement.html">
            
                    
                    Global Placement
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.2" data-path="../pnr/detailed-placement.html">
            
                <a href="../pnr/detailed-placement.html">
            
                    
                    Detailed Placement
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../pnr/routing.html">
            
                <a href="../pnr/routing.html">
            
                    
                    Routing
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.3.1" data-path="../pnr/global-routing.html">
            
                <a href="../pnr/global-routing.html">
            
                    
                    Global Routing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.2" data-path="../pnr/detailed-routing.html">
            
                <a href="../pnr/detailed-routing.html">
            
                    
                    Detailed Routing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../pnr/bitstream-gen.html">
            
                <a href="../pnr/bitstream-gen.html">
            
                    
                    Bitstream Generation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../pnr/testing.html">
            
                <a href="../pnr/testing.html">
            
                    
                    Testing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="../pnr/analysis.html">
            
                <a href="../pnr/analysis.html">
            
                    
                    Analysis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="../pnr/retiming.html">
            
                <a href="../pnr/retiming.html">
            
                    
                    Retiming
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../bsbuilder/bsbuilder.html">
            
                <a href="../bsbuilder/bsbuilder.html">
            
                    
                    Assembler (BSBuilder)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../bsbuilder/bitstream-spec.html">
            
                <a href="../bsbuilder/bitstream-spec.html">
            
                    
                    Bitstream Specification
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../simulator/simulator.html">
            
                <a href="../simulator/simulator.html">
            
                    
                    Simulator (run_tbg)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="intro.html">
            
                <a href="intro.html">
            
                    
                    Test Bench Generator
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.9.1" data-path="harness_generation.html">
            
                <a href="harness_generation.html">
            
                    
                    Harness Generation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="io-json.html">
            
                <a href="io-json.html">
            
                    
                    .io.json format
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="pre_post_processing.html">
            
                <a href="pre_post_processing.html">
            
                    
                    Pre/Post Processing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="roadmap.html">
            
                <a href="roadmap.html">
            
                    
                    Roadmap
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Harness Generation</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="overview">Overview</h1>
<p>Stages of harness generation</p>
<ul>
<li>define tracing macros (if enabled)</li>
<li>chip reset (based on pnr collateral)</li>
<li>configuration (based on use_jtag)</li>
<li>(optional) verify config (use_jtag only)</li>
<li>main loop <ul>
<li>stream input file data to input pads</li>
<li>step the global clock</li>
<li>stream output pad values to output files</li>
</ul>
</li>
</ul>
<h2 id="details">Details</h2>
<p>Generating the harness is divided into the metaprogramming of 11 specific
program components:</p>
<ul>
<li><a href="#includes">Includes</a></li>
<li><a href="#trace-setup">trace setup</a> (<code>--trace</code> only)</li>
<li><a href="#file-setup">file setup</a></li>
<li><a href="#jtag-setup">jtag setup</a></li>
<li><a href="#chip-init">chip init</a></li>
<li><a href="#chip-reset">chip reset</a></li>
<li><a href="#chip-stalling---use-jtag-only">chip stalling (<code>--use-jtag</code> only)</a></li>
<li><a href="#running-configuration">running configuration</a></li>
<li><a href="#verifying-configuration---use-jtag-and---verify-config-only">verifying configuration (<code>--use-jtag</code> and <code>--verify-config</code> only)</a></li>
<li><a href="#chip-unstallingreset">chip unstalling/reset</a></li>
<li><a href="#clock-switch---use-jtag-only">clock switch (<code>--use-jtag</code> only)</a></li>
<li><a href="#running-test">running test</a></li>
</ul>
<h3 id="includes">Includes</h3>
<p>This sets up include files used by the harness. All generated test benches will
include verilator&apos;s header file (<code>verilated.h</code>) and various standard library
headers (<code>&lt;iostream&gt;</code>, <code>stdint.h</code>, <code>&lt;fstream&gt;</code>, <code>printf.h</code>).  The one
dynamically generated include is for the verilator module <code>V{wrapper_name}.h</code>
where <code>wrapper_name</code> corresponds to the name of the top module in the generated
Verilog.</p>
<h3 id="trace-setup">Trace Setup</h3>
<p>If <code>--trace</code> is enabled, the harness will append <code>verilated_vcd_c.h</code> to the
include files, as well as some code to setup the tracing logic.  In particular,
it calls the verilator function <code>Verilated::traceEverOn(true)</code> to configure
verilator to perform tracing. Then, it sets up a VCD file for verilator to dump
the trace too, configured by the <code>--trace-file-name</code> parameter, and adds the
code to close the trace file during cleanup. It also sets up a <code>time_step</code>
variable used to track the current time step during test execution.  Finally,
the <code>next</code> and <code>step</code> macros are redefined to include the required method calls
to dump the current state of the simulation to the trace file for each clock
step.</p>
<h3 id="file-setup">File Setup</h3>
<p>This code handles the opening of <code>fstream</code> objects for the input and output
files specified by the PnR collateral.  The <code>--input-chunk-size</code> and
<code>--output-chunk-size</code> parameters specify the size in bits of the data in the
input and output files.</p>
<h3 id="jtag-setup">JTAG Setup</h3>
<p>If <code>--use-jtag</code> is enabled, the harness includes <code>jtagdriver.h</code> which defines
the interface to the C++ JTAG driver.  It also adds an instantiation of the
<code>JTAGDriver</code> object which will be used by the configuration code.</p>
<h3 id="chip-init">Chip Init</h3>
<p>This phase initializes the <code>clk_pad</code> and <code>reset_pad</code> inputs to be zero. If
<code>--use-jtag</code> is enabled, it also calls <code>jtag.init()</code> which initializes the jtag
ports to zero. Then, it calls <code>eval</code> once.</p>
<h3 id="chip-reset">Chip Reset</h3>
<p>This phase resets the chip by setting <code>reset_pad</code> to 1, calling <code>eval</code>, setting
<code>reset_pad</code> to 0, and calling <code>eval</code>.  If <code>--use-jtag</code> is enabled, it will
reset the chip using the <code>trst_n</code> port, and then bring up the JTAG clock by
setting <code>tck</code> to 1 and stepping twice.</p>
<h3 id="chip-stalling---use-jtag-only">Chip Stalling (<code>--use-jtag</code> only)</h3>
<p>If <code>--use-jtag</code> is enabled, this phase will stall the chip by writing <code>0xF</code> to
the <code>OP_WRITE_STALL</code> register of the JTAG TAP.</p>
<h3 id="running-configuration">Running Configuration</h3>
<p>This phase loops over the bitstream and sends the commands to configure the
chip.  If <code>--use-jtag</code> is enabled, it will use the <code>JTAGDriver</code> to configure
the chip with the <code>write_config</code> method. Otherwise, it will directly poke the
<code>config_data_in</code> and <code>config_addr_in</code> ports and step the clock twice.</p>
<h3 id="verifying-configuration---use-jtag-and---verify-config-only">Verifying configuration (<code>--use-jtag</code> and <code>--verify-config</code> only)</h3>
<p>If <code>--use-jtag</code> and <code>--verify-config</code> are enabled, this phase will read the
configuration state back (inverse of the configuration phase) to verify that
the chip has been properly configured through the global controller.</p>
<h3 id="chip-unstallingreset">Chip Unstalling/Reset</h3>
<p>If <code>--use-jtag</code> is enabled, this phase will unstall the chip by writing <code>0x0</code>
to the <code>OP_WRITE_STALL</code> register of the JTAG TAP.</p>
<p>Otherwise, it sets the <code>reset_in_pad</code> provided by the PnR collateral to 1,
which resets the chip state.</p>
<h3 id="clock-switch---use-jtag-only">Clock Switch (<code>--use-jtag</code> only)</h3>
<p>If <code>--use-jtag</code> is enabled, this phase switches the clock from the test clock
(used for configuration) to the fast clock (used for normal operation).  The
<code>JTAGDriver</code> provides a method <code>switch_to_fast</code>.</p>
<h3 id="running-test">Running Test</h3>
<p>To actually run the test, the harness generates a loop that streams data from
the input files, pokes the values onto the input pads specified by the PnR
collateral, steps the clock, streams the output pad values to the output files,
and steps the clock.  This loop runs until any of the input file streams close
(run out of data).
<img src="img/harness-loop.svg" alt="Harness Loop"></p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="intro.html" class="navigation navigation-prev " aria-label="Previous page: Test Bench Generator">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="io-json.html" class="navigation navigation-next " aria-label="Next page: .io.json format">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Harness Generation","level":"1.9.1","depth":2,"next":{"title":".io.json format","level":"1.9.2","depth":2,"path":"tbg/io-json.md","ref":"tbg/io-json.md","articles":[]},"previous":{"title":"Test Bench Generator","level":"1.9","depth":1,"path":"tbg/intro.md","ref":"tbg/intro.md","articles":[{"title":"Harness Generation","level":"1.9.1","depth":2,"path":"tbg/harness_generation.md","ref":"tbg/harness_generation.md","articles":[]},{"title":".io.json format","level":"1.9.2","depth":2,"path":"tbg/io-json.md","ref":"tbg/io-json.md","articles":[]},{"title":"Pre/Post Processing","level":"1.9.3","depth":2,"path":"tbg/pre_post_processing.md","ref":"tbg/pre_post_processing.md","articles":[]},{"title":"Roadmap","level":"1.9.4","depth":2,"path":"tbg/roadmap.md","ref":"tbg/roadmap.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["mathjax","expandable-chapters"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"mathjax":{"forceSVG":false,"version":"2.6.1"},"expandable-chapters":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"The Ultimate Documentation for CGRAFlow","gitbook":"*"},"file":{"path":"tbg/harness_generation.md","mtime":"2021-09-15T21:43:16.164Z","type":"markdown"},"gitbook":{"version":"3.6.20","time":"2021-09-15T21:43:34.796Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-mathjax/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

